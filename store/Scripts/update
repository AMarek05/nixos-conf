#!/usr/bin/env bash
#
# Sync local ~/gdrive with Google Drive remote gdrive:Laptop
# Usage:
#   ./sync [upload|download]
#

set -euo pipefail

LOCAL_DIR="$HOME/gdrive"
REMOTE_DIR="gdrive:Remote"
MODE="${1:-upload}"
PARALLEL=8

if ! command -v rclone &>/dev/null; then
    echo "FATAL: rclone not found. Please install it first." >&2
    exit 1
fi

if [ ! -d "$LOCAL_DIR" ]; then
    echo "ERR: Local directory not found: $LOCAL_DIR" >&2
    echo "Creating: $LOCAL_DIR"
    mkdir -p "$LOCAL_DIR"
fi

echo "==== $(date '+%Y-%m-%d %H:%M:%S') ===="
echo "Mode: $MODE"
echo

case "$MODE" in
    upload)
        SRC="$LOCAL_DIR"
        DEST="$REMOTE_DIR"
        ;;
    download)
        SRC="$REMOTE_DIR"
        DEST="$LOCAL_DIR"
        ;;
    *)
        echo "FATAL: Invalid mode: $MODE (use 'upload' or 'download')" >&2
        exit 1
        ;;
esac

rclone copy -P --checkers $((PARALLEL*2)) --transfers $PARALLEL --drive-use-trash=false --filters-from ~/gdrive/filters.txt "$SRC" "$DEST"

echo "EXIT: Sync completed successfully."
exit 0
