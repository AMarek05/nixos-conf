#!/usr/bin/env bash
#
# Sync local files with Google Drive or arbitrary remotes
# Usage: ./sync -[u|d] -[s|c] -[n|i|N] -p [path] -r [remote]
#

set -euo pipefail

# --- Configuration ---
DEFAULT_LOCAL_ROOT="${HOME}/gdrive"
DEFAULT_REMOTE_ROOT="gdrive:Remote"
FILTER_FILE="${HOME}/gdrive/filters.txt"
PARALLEL=8

# --- Defaults ---
DIRECTION="upload"
ACTION="sync"
DRY_RUN=false
INTERACTIVE=false
USE_FILTER=true
INLINE_FILTERS=()
TARGET_SUBPATH=""
REMOTE_DEST=""
IS_CUSTOM_REMOTE=false

# --- Helper Functions ---
usage() {
    echo "Usage: $0 [options]"
    echo ""
    echo "  -u    Upload: Local -> Remote (Default)"
    echo "  -d    Download: Remote -> Local"
    echo "  -s    Sync: Delete destination files to match source (Default)"
    echo "  -c    Copy: Additive only, no deletions"
    echo "  -n    Dry-run: Show what would happen without doing it"
    echo "  -i    Interactive: Ask for confirmation"
    echo "  -N    No Filter: Do not use filters.txt (Sync everything)"
    echo "  -f    Filter: Add an inline filter rule (e.g., -f '- *.tmp')"
    echo "  -p    Path: Local path to sync."
    echo "              (If -r is NOT set: must be inside ~/gdrive)"
    echo "              (If -r IS set: can be any absolute or relative path)"
    echo "  -r    Remote: Override destination (e.g. gdrive:Backups)"
    echo "              (Disables auto-directory mirroring)"
    echo "  -h    Show this help"
    echo ""
    exit 1
}

log() {
    echo "[$1] $2"
}

# --- Argument Parsing ---
while getopts ":udscnihp:r:Nf:" opt; do
    case ${opt} in
    u) DIRECTION="upload" ;;
    d) DIRECTION="download" ;;
    s) ACTION="sync" ;;
    c) ACTION="copy" ;;
    n) DRY_RUN=true ;;
    i) INTERACTIVE=true ;;
    N) USE_FILTER=false ;;
    f) INLINE_FILTERS+=("$OPTARG") ;;
    p) TARGET_SUBPATH="$OPTARG" ;;
    r)
        REMOTE_DEST="${OPTARG%/}"
        IS_CUSTOM_REMOTE=true
        ;;
    h) usage ;;
    \?)
        echo "Invalid Option: -$OPTARG" >&2
        usage
        ;;
    esac
done
shift $((OPTIND - 1))

# --- Pre-flight Checks ---

if ! command -v rclone &>/dev/null; then
    echo "FATAL: rclone not found. Please install it first." >&2
    exit 1
fi

# --- Logic: Path Resolution ---

# 1. Determine Local Path (SRC base)
if [ -n "$TARGET_SUBPATH" ]; then
    LOCAL_DIR=$(realpath "$TARGET_SUBPATH")
else
    LOCAL_DIR="$DEFAULT_LOCAL_ROOT"
fi

# 2. Determine Remote Path (DEST base)
if [ "$IS_CUSTOM_REMOTE" = true ]; then
    # Custom Mode: Strict mapping
    REMOTE_DIR="$REMOTE_DEST"
    log "INFO" "Custom remote mode: Mapping '$LOCAL_DIR' directly to '$REMOTE_DIR'"

else
    # Managed Mode: Safety checks + Structure mirroring
    if [[ "$LOCAL_DIR" != "$DEFAULT_LOCAL_ROOT"* ]]; then
        log "FATAL" "Safety Check: Path '$LOCAL_DIR' is outside '$DEFAULT_LOCAL_ROOT'"
        log "FATAL" "Use -r [remote] if you want to sync arbitrary locations."
        exit 1
    fi

    RELATIVE="${LOCAL_DIR#"$DEFAULT_LOCAL_ROOT"}"
    RELATIVE="${RELATIVE#/}"

    REMOTE_DIR="$DEFAULT_REMOTE_ROOT"

    if [ -n "$RELATIVE" ]; then
        REMOTE_DIR="${REMOTE_DIR}/${RELATIVE}"
        log "INFO" "Managed mode: Mirroring subdirectory '/$RELATIVE'"
    else
        log "INFO" "Managed mode: Syncing root ($LOCAL_DIR)"
    fi
fi

# --- Direction Setup ---

if [ "$DIRECTION" == "upload" ]; then
    SRC="$LOCAL_DIR"
    DEST="$REMOTE_DIR"
    DIR_ICON="⬆️  (Upload)"
else
    SRC="$REMOTE_DIR"
    DEST="$LOCAL_DIR"
    DIR_ICON="⬇️  (Download)"
fi

if [ "$DIRECTION" == "upload" ] && [ ! -d "$SRC" ]; then
    log "WARN" "Local source directory not found: $SRC"
    exit 1
fi

# --- Command Execution ---

CMD_OPTS=(-P --checkers $((PARALLEL * 2)) --transfers "$PARALLEL" --drive-use-trash=true --verbose)

# --- Logic to handle Filters ---

# 1. Apply Inline Filters first (passed via -f)
for filter in "${INLINE_FILTERS[@]}"; do
    CMD_OPTS+=(--filter "$filter")
done

# 2. Apply File Filters (unless -N is set)
if [ "$USE_FILTER" = true ]; then
    if [ -f "$FILTER_FILE" ]; then
        CMD_OPTS+=(--filter-from "$FILTER_FILE")
    fi
else
    if [ ${#INLINE_FILTERS[@]} -eq 0 ]; then
        log "INFO" "Filters disabled (-N) and no inline filters (-f): Syncing all files."
    fi
fi

if [ "$DRY_RUN" = true ]; then
    CMD_OPTS+=(--dry-run)
    log "INFO" "⚠️  DRY RUN MODE: No changes will be applied."
fi

if [ "$INTERACTIVE" = true ]; then
    CMD_OPTS+=(--interactive)
fi

echo "========================================"
echo "Direction : $DIR_ICON"
echo "Action    : $ACTION"
echo "Source    : $SRC"
echo "Dest      : $DEST"
echo "========================================"
echo

rclone "$ACTION" "${CMD_OPTS[@]}" "$SRC" "$DEST"

echo
log "EXIT" "Sync completed."
